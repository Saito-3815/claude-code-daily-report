// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 営業担当者
model Salesperson {
  id           BigInt   @id @default(autoincrement())
  employeeCode String   @unique @map("employee_code") @db.VarChar(10)
  name         String   @db.VarChar(50)
  email        String   @unique @db.VarChar(255)
  password     String   @db.VarChar(128)
  managerId    BigInt?  @map("manager_id")
  department   String   @db.VarChar(50)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // リレーション
  manager      Salesperson?  @relation("ManagerSubordinate", fields: [managerId], references: [id])
  subordinates Salesperson[] @relation("ManagerSubordinate")
  dailyReports DailyReport[]
  comments     Comment[]

  @@index([email])
  @@index([department])
  @@index([managerId])
  @@map("salesperson")
}

// 顧客
model Customer {
  id           BigInt   @id @default(autoincrement())
  customerCode String   @unique @map("customer_code") @db.VarChar(10)
  name         String   @db.VarChar(100)
  postalCode   String?  @map("postal_code") @db.VarChar(8)
  address      String?  @db.VarChar(255)
  phone        String?  @db.VarChar(20)
  industry     String?  @db.VarChar(50)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // リレーション
  visitRecords VisitRecord[]

  @@index([name])
  @@index([industry])
  @@index([isActive])
  @@map("customer")
}

// 日報
model DailyReport {
  id            BigInt    @id @default(autoincrement())
  salespersonId BigInt    @map("salesperson_id")
  reportDate    DateTime  @map("report_date") @db.Date
  status        String    @default("draft") @db.VarChar(20) // draft, submitted, confirmed
  submittedAt   DateTime? @map("submitted_at")
  confirmedAt   DateTime? @map("confirmed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // リレーション
  salesperson  Salesperson   @relation(fields: [salespersonId], references: [id])
  visitRecords VisitRecord[]
  problems     Problem[]
  plans        Plan[]

  @@unique([salespersonId, reportDate])
  @@index([salespersonId])
  @@index([reportDate])
  @@index([status])
  @@map("daily_report")
}

// 訪問記録
model VisitRecord {
  id            BigInt   @id @default(autoincrement())
  dailyReportId BigInt   @map("daily_report_id")
  customerId    BigInt   @map("customer_id")
  visitTime     String?  @map("visit_time") @db.VarChar(5) // HH:MM format
  content       String   @db.Text
  result        String?  @db.VarChar(20) // negotiating, closed, rejected, info_gathering
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // リレーション
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  customer    Customer    @relation(fields: [customerId], references: [id])

  @@index([dailyReportId])
  @@index([customerId])
  @@map("visit_record")
}

// 課題・相談
model Problem {
  id            BigInt   @id @default(autoincrement())
  dailyReportId BigInt   @map("daily_report_id")
  content       String   @db.Text
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // リレーション
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  // Note: コメントとの関連はアプリケーションレベルで管理

  @@index([dailyReportId])
  @@map("problem")
}

// 明日やること
model Plan {
  id            BigInt   @id @default(autoincrement())
  dailyReportId BigInt   @map("daily_report_id")
  content       String   @db.Text
  displayOrder  Int      @default(0) @map("display_order")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // リレーション
  dailyReport DailyReport @relation(fields: [dailyReportId], references: [id], onDelete: Cascade)
  // Note: コメントとの関連はアプリケーションレベルで管理

  @@index([dailyReportId])
  @@map("plan")
}

// コメント
model Comment {
  id              BigInt   @id @default(autoincrement())
  salespersonId   BigInt   @map("salesperson_id")
  commentableType String   @map("commentable_type") @db.VarChar(20) // Problem, Plan
  commentableId   BigInt   @map("commentable_id")
  content         String   @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // リレーション
  salesperson Salesperson @relation(fields: [salespersonId], references: [id])
  // Note: ポリモーフィック関連はアプリケーションレベルで管理

  @@index([salespersonId])
  @@index([commentableType, commentableId])
  @@map("comment")
}
